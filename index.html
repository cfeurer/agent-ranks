<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Agent Ranks — Private, Unbiased Agent Matching (Demo Safe Mode + Dashboard)</title>
<style>
  :root{
    --navy:#0B1F3B; --gold:#C49A6C; --ink:#0F172A; --muted:#475569; --border:#E2E8F0; --soft:#F8FAFC; --bg:#FFFFFF;
    --shadow:0 1px 2px rgba(0,0,0,.06), 0 2px 8px rgba(0,0,0,.06); --radius:14px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg)}
  a{color:var(--ink);text-decoration:none}
  .container{max-width:1100px;margin:0 auto;padding:0 16px}
  .btn{background:var(--ink);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn-outline{background:#fff;color:var(--ink);border:1px solid var(--border);border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .section{padding:48px 0} /* tightened to lift content */
  .h1{font-size:40px;line-height:1.1;font-weight:800;letter-spacing:-.02em}
  .h2{font-size:28px;font-weight:800;letter-spacing:-.02em}
  .h3{font-size:16px;font-weight:800}
  .muted{color:var(--muted)}
  .row{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:720px){ .row-2{grid-template-columns:1.2fr .8fr} .row-3{grid-template-columns:repeat(3,1fr)} }
  header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:50}
  nav a{margin-right:16px;font-size:14px}
  .pill{display:inline-flex;padding:6px 12px;border-radius:999px;border:1px solid rgba(17,24,39,.15);background:rgba(17,24,39,.03);font-size:12px;font-weight:700}
  .hero-visual{height:320px;border-radius:16px;border:1px solid var(--border);overflow:hidden;position:relative}
  .hero-img{position:absolute;inset:0;background-size:cover;background-position:center;opacity:0;transition:opacity .6s}
  .hero-img.active{opacity:1}
  .hero-overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0) 35%,rgba(0,0,0,.55) 100%)}
  .hero-caption{position:absolute;left:16px;right:16px;bottom:16px;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.6)}
  .hero-cap-title{font-weight:800;font-size:16px;letter-spacing:.01em}
  .hero-cap-sub{font-size:12px;opacity:.9}
  .progress{height:8px;width:180px;background:#f1f5f9;border-radius:999px;overflow:hidden}
  .progress>div{height:100%;background:var(--ink)}
  .grid-2{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:700px){ .grid-2{grid-template-columns:repeat(2,1fr)} }
  .grid-3{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:700px){ .grid-3{grid-template-columns:repeat(3,1fr)} }
  .list{list-style:disc;padding-left:18px}
  .small{font-size:12px} .xsmall{font-size:11px;color:#64748b}
  .pillbar{display:flex;gap:8px;flex-wrap:wrap}
  .choice{padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;text-align:left;cursor:pointer}
  .choice.selected{border-color:var(--ink);background:#111827;color:#fff}
  .choice.selected .muted{color:#e5e7eb}
  .hidden{display:none}
  .footer{border-top:1px solid var(--border);background:#fff}
  #chat-fab{position:fixed;right:18px;bottom:18px;z-index:60}
  .modal.hidden,.hidden,#chat-modal[aria-hidden="true"]{display:none !important}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:16px;z-index:100}
  /* Mobile */
  @media(max-width:480px){ .h1{font-size:32px} .h2{font-size:24px} .brand-name{font-size:1.3em} .hero-visual{height:260px} }
</style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <span id="brand-badge" aria-hidden="true"></span>
        <strong class="brand-name" style="font-size:1.3em">Agent Ranks</strong>
        <span class="xsmall" style="margin-left:10px;color:#64748b;">DEMO MODE — no emails sent</span>
      </div>
      <nav class="hide-mobile">
        <a href="#how">How it works</a>
        <a href="#questionnaire">Get matched</a>
        <a href="#mortgage">Mortgage & Insurance</a>
        <a href="#admin">Pilot data</a>
        <a href="#demo">Demo Runner</a>
        <a href="#dash">Dashboard</a>
        <a href="#legal">Policies</a>
      </nav>
      <a href="#questionnaire" class="btn">Find my best match</a>
    </div>
  </header>

  <!-- HERO -->
  <section class="section hero" style="padding-top:32px;padding-bottom:28px;">
    <div class="container row row-2">
      <div>
        <span class="pill">Unbiased – Credit Score Level Ratings</span>
        <h1 class="h1" style="margin-top:12px;">Find your best-fit real estate agent — privately</h1>
        <p class="muted" style="margin-top:8px;max-width:600px;">
          50+ matching signals (neighborhood, property type, price <strong>range</strong>, buyer/seller focus, marketing power, track record).
          We present your best 3 matches — with no names or contact shared until <em>both</em> sides opt-in.
        </p>
        <div style="display:flex;gap:10px;margin-top:16px;">
          <a class="btn" href="#questionnaire">Start 2-minute match</a>
          <a class="btn btn-outline" href="#how">How it works</a>
        </div>
      </div>
      <div class="hero-visual">
        <div class="hero-img active" id="slide0"></div>
        <div class="hero-img" id="slide1"></div>
        <div class="hero-img" id="slide2"></div>
        <div class="hero-overlay"></div>
        <div class="hero-caption">
          <div class="hero-cap-title" id="capTitle">Accepted over ask</div>
          <div class="hero-cap-sub" id="capSub">Bucktown • SFH • 11 days — “We met three great options anonymously and chose the one who sold our place in 11 days.”</div>
        </div>
      </div>
    </div>
  </section>

  <!-- HOW IT WORKS -->
  <section id="how" class="section" style="padding-top:28px;">
    <div class="container">
      <h2 class="h2">How it works</h2>
      <p class="muted" style="margin-top:6px;">Unbiased, data-driven matches. Comfortable, private introductions.</p>
      <div class="row row-3" style="margin-top:16px;">
        <div class="card" style="padding:18px;"><div class="chip">1</div><div class="h3" style="margin-top:8px;">Tell us your goals</div><div class="small muted">Buyer or seller, neighborhood, property type, price <strong>range</strong>, timing, and key priorities.</div></div>
        <div class="card" style="padding:18px;"><div class="chip">2</div><div class="h3" style="margin-top:8px;">AI-assisted matching</div><div class="small muted">We weigh 50+ signals to rank agents most likely to achieve your outcome.</div></div>
        <div class="card" style="padding:18px;"><div class="chip">3</div><div class="h3" style="margin-top:8px;">Anonymous introductions</div><div class="small muted">Review short narratives for your top matches without exposing identity or contact info.</div></div>
        <div class="card" style="padding:18px;"><div class="chip">4</div><div class="h3" style="margin-top:8px;">Mutual opt-in & connect</div><div class="small muted">If you approve, we reveal identities and open private chat. We request payment via Direction to Pay at close.</div></div>
      </div>
    </div>
  </section>

  <!-- QUESTIONNAIRE -->
  <section id="questionnaire" class="section">
    <div class="container">
      <h2 class="h2">Get matched in under 2 minutes</h2>
      <p class="muted">We only share anonymized needs until you choose to connect.</p>
      <div class="card" style="margin-top:14px;padding:16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <div class="xsmall">Step <span id="step-num">1</span> of 6</div>
          <div class="progress"><div id="progress-bar" style="width:16.66%"></div></div>
        </div>
        <div id="step-0" style="margin-top:12px;">
          <div class="h3">Are you buying or selling?</div>
          <div class="grid-2" style="margin-top:10px;">
            <button class="choice" data-role="Buyer"><div class="h3">Buyer</div><div class="small muted">We’ll prioritize negotiation and availability.</div></button>
            <button class="choice" data-role="Seller"><div class="h3">Seller</div><div class="small muted">We’ll prioritize marketing power and days-on-market.</div></button>
          </div>
        </div>
        <div id="step-1" class="hidden" style="margin-top:12px;">
          <div class="h3">What neighborhood or area?</div>
          <input id="input-location" class="input" placeholder="e.g., West Loop, Lincoln Park, Hinsdale"
                 style="width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px">
          <div class="xsmall" style="margin-top:6px;">Tip: You can be specific (e.g., “Bucktown”) or broader (e.g., “North Shore”).</div>
        </div>
        <div id="step-2" class="hidden" style="margin-top:12px;">
          <div class="h3">Property type</div>
          <div class="grid-3" style="margin-top:10px;" id="property-types"></div>
        </div>
        <div id="step-3" class="hidden" style="margin-top:12px;">
          <div class="h3">Price range</div>
          <div class="grid-2" style="margin-top:10px;">
            <div><div class="xsmall">Min</div><input id="price-min" type="number" class="input" style="width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px" value="400000"></div>
            <div><div class="xsmall">Max</div><input id="price-max" type="number" class="input" style="width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px" value="1000000"></div>
          </div>
          <div class="xsmall" style="margin-top:6px;">Change later if you’re uncertain.</div>
        </div>
        <div id="step-4" class="hidden" style="margin-top:12px;">
          <div class="h3">What matters most?</div>
          <div id="priorities" class="grid-2" style="margin-top:10px;"></div>
        </div>
        <div id="step-5" class="hidden" style="margin-top:12px;">
          <div class="h3">Timing</div>
          <div class="grid-3" style="margin-top:10px;">
            <button class="choice timing" data-val="0-3 months">0-3 months</button>
            <button class="choice timing" data-val="3-6 months">3-6 months</button>
            <button class="choice timing" data-val="6-12 months">6-12 months</button>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px;">
          <button class="btn btn-outline" id="btn-back">Back</button>
          <button class="btn" id="btn-next">Next</button>
          <button class="btn hidden" id="btn-finish">See my matches</button>
        </div>
        <div class="xsmall" style="margin-top:8px;">Your details remain private. We only open a chat if you approve your matches and the agent agrees.</div>
      </div>
    </div>
  </section>

  <!-- RESULTS -->
  <section id="results" class="section hidden">
    <div class="container">
      <h2 class="h2">Your best-fit matches</h2>
      <p class="muted">We highlight the top three based on your goals. You can still browse up to ten options.</p>
      <div id="top3" class="row row-3" style="margin-top:16px;"></div>
      <div style="margin-top:28px;"><div class="h3">Other relevant options</div><div id="rest" class="row row-3" style="margin-top:12px;"></div></div>

      <div class="card" style="margin-top:28px;padding:16px;background:var(--soft);">
        <div class="h3">Mortgage & Insurance (optional)</div>
        <div class="small muted" style="margin-top:6px;">Prefer a lender or insurance broker style? We’ll factor that into your matches too.</div>
        <div class="row row-3" style="margin-top:12px;">
          <label class="small"><input type="checkbox"> I want a rate-shopper lender</label>
          <label class="small"><input type="checkbox"> I prefer concierge service</label>
          <label class="small"><input type="checkbox"> I need jumbo loan expertise</label>
        </div>
      </div>
    </div>
  </section>

  <!-- MORTGAGE STRIP -->
  <section id="mortgage" class="section">
    <div class="container">
      <h2 class="h2">Mortgage & Insurance referrals</h2>
      <p class="muted">When you're ready, we can introduce you to vetted lenders and brokers based on your profile.</p>
      <div class="row row-3" style="margin-top:12px;">
        <div class="card" style="padding:16px;"><div class="h3">Rate-first lenders</div><div class="small muted">We’ll factor your preference into matching and keep your info private until you opt-in.</div><button class="btn" style="margin-top:10px;">Add to my matches</button></div>
        <div class="card" style="padding:16px;"><div class="h3">Concierge lenders</div><div class="small muted">We’ll factor your preference into matching and keep your info private until you opt-in.</div><button class="btn" style="margin-top:10px;">Add to my matches</button></div>
        <div class="card" style="padding:16px;"><div class="h3">Insurance brokers</div><div class="small muted">We’ll factor your preference into matching and keep your info private until you opt-in.</div><button class="btn" style="margin-top:10px;">Add to my matches</button></div>
      </div>
    </div>
  </section>

  <!-- ADMIN CSV -->
  <section id="admin" class="section">
    <div class="container">
      <h2 class="h2">Pilot data (CSV import) — Chicagoland</h2>
      <p class="muted">Paste a simple CSV to test with real-looking agent stats before MLS integration.</p>
      <div class="card" style="padding:16px;margin-top:12px;">
        <div class="small">Columns: <code>id, alias, neighborhoods (;), propertyTypes (;), priceMin, priceMax, focus, marketing, negotiation, transactions12m, resources (;), brokerageMarketing, domVsArea, spLpVsArea, buyDiscountVsArea</code></div>
        <textarea id="csv" rows="8" style="margin-top:10px;width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:12px" placeholder="id,alias,neighborhoods,propertyTypes,priceMin,priceMax,focus,marketing,negotiation,transactions12m,resources,brokerageMarketing,domVsArea,spLpVsArea,buyDiscountVsArea
X1,West Loop Condo Pro,West Loop;River North,Condo;Loft,600000,1600000,Seller,5,3,48,3D Tours;Broker Events;Pro Video,5,-8,1.1,0
X2,North Shore Seller Strategist,Winnetka;Glencoe;Evanston;Wilmette,Single Family,900000,3500000,Seller,5,4,34,Staging;Aerial Video;Broker Network,5,-8,1.3,0
X3,First-Time Buyer Guide,Lincoln Square;Ravenswood;Logan Square,Condo;Townhome,300000,800000,Buyer,3,5,38,Lender Intros;Buyer Workshops;Offer Playbooks,4,0,0,1.0"></textarea>
        <div style="display:flex;gap:10px;align-items:center;margin-top:10px;">
          <button id="load-sample" class="btn btn-outline">Load sample</button>
          <button id="import" class="btn">Import CSV</button>
          <span id="status" class="xsmall"></span>
        </div>
      </div>
    </div>
  </section>

  <!-- DEMO RUNNER -->
  <section id="demo" class="section">
    <div class="container">
      <h2 class="h2">Demo Runner (safe / no email)</h2>
      <div class="card" style="padding:16px; margin-top:12px;">
        <div class="small muted">This simulates buyers/sellers end-to-end using synthetic data and your live scoring. No emails or texts are sent.</div>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <button class="btn btn-outline" id="demo-load">Load demo scenarios (20)</button>
          <button class="btn" id="demo-run">Run 10 demo sessions</button>
          <button class="btn btn-outline" id="demo-download">Download KPI</button>
        </div>
        <div class="xsmall" style="margin-top:10px;">Log:</div>
        <pre id="demo-log" class="small" style="background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:10px;max-height:300px;overflow:auto;white-space:pre-wrap;"></pre>
      </div>
    </div>
  </section>

  <!-- DASHBOARD (read-only, in-browser) -->
  <section id="dash" class="section">
    <div class="container">
      <h2 class="h2">Admin Dashboard</h2>
      <p class="muted">Read-only charts from local KPI logs. Use the <strong>Demo Runner</strong> to generate sessions, then refresh this view.</p>

      <div class="row row-3" style="margin-top:12px;">
        <div class="card" style="padding:14px;">
          <div class="h3">Paid Referral Closings (30d)</div>
          <div id="tilePRC" class="h1" style="margin-top:6px;">—</div>
          <div class="xsmall" id="tilePRCtxt"></div>
        </div>
        <div class="card" style="padding:14px;">
          <div class="h3">Median First Response</div>
          <div id="tileSLA" class="h1" style="margin-top:6px;">—</div>
          <div class="xsmall" id="tileSLAtxt">SLA target ≤ 4h</div>
        </div>
        <div class="card" style="padding:14px;">
          <div class="h3">PLIDs (last 7d)</div>
          <div id="tilePLID" class="h1" style="margin-top:6px;">—</div>
          <div class="xsmall" id="tilePLIDtxt"></div>
        </div>
      </div>

      <div class="card" style="padding:14px; margin-top:14px;">
        <div class="h3">Client Funnel (30d)</div>
        <canvas id="chartFunnel" width="900" height="160" style="max-width:100%;"></canvas>
        <div class="xsmall" id="funnelTxt" style="margin-top:6px;"></div>
      </div>

      <div class="card" style="padding:14px; margin-top:14px;">
        <div class="h3">PLIDs per day (last 14 days)</div>
        <canvas id="chartPLID" width="900" height="160" style="max-width:100%;"></canvas>
        <div class="xsmall">Tip: Run the Demo Runner to populate this quickly.</div>
      </div>

      <div class="card" style="padding:14px; margin-top:14px;">
        <div class="h3">Supply Snapshot</div>
        <div id="supplyTxt" class="small" style="margin-top:6px;"></div>
      </div>
    </div>
  </section>

  <!-- POLICIES -->
  <section id="legal" class="section">
    <div class="container">
      <h2 class="h2">Policies & Agreements</h2>
      <details class="card" style="padding:14px;margin-top:12px;"><summary class="h3">Scoring Policy (summary)</summary>
        <p class="small" style="margin-top:8px">
          We score agents using 50+ signals: neighborhood specialization, property type fit, price range overlap, buyer/seller focus,
          resources (marketing & negotiation), brokerage marketing power, and success & track record (seller: DOM & SP/LP vs area; buyer: price improvement vs area).
          Scores are normalized; responsiveness and reliability can adjust the total. We do not accept pay-to-rank. If a top match is outside our eligible pool
          (no referral agreement yet), we will attempt to onboard them within hours; otherwise we present the next closest eligible match.
        </p>
      </details>
      <details class="card" style="padding:14px;margin-top:12px;"><summary class="h3">Privacy (summary)</summary>
        <p class="small" style="margin-top:8px">
          We collect minimal data (email/mobile) to register you as a Protected Lead (PLID). We do not reveal your identity or contact
          information to any agent until you tap Connect and the agent accepts our terms. We store timestamps and limited metadata to
          protect introductions and to improve the service. We do not sell personal data.
        </p>
      </details>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;padding:16px 0;">
      <div class="xsmall">© <span id="year"></span> Agent Ranks — Demo Concept</div>
      <div class="xsmall"><a href="#how">How it works</a> · <a href="#admin">Pilot data</a> · <a href="#demo">Demo Runner</a> · <a href="#dash">Dashboard</a> · <a href="#legal">Policies</a></div>
    </div>
  </footer>

  <!-- ACTION BUTTONS / MODALS -->
  <button id="chat-fab" class="btn" title="Open chat">Chat</button>

  <!-- Chat Modal -->
  <div id="chat-modal" class="modal hidden" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" style="width:min(720px,100%);max-height:80vh;display:flex;flex-direction:column;">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);">
        <div><div class="xsmall">Anonymous chat</div><div class="h3" id="chat-title">Agent</div></div>
        <div style="display:flex;gap:8px;"><button class="btn btn-outline" id="chat-min">Minimize</button><button class="btn btn-outline" id="chat-close">Close</button></div>
      </div>
      <div id="chat-messages" style="padding:12px;overflow:auto;height:50vh;"></div>
      <div style="display:flex;gap:8px;padding:12px;border-top:1px solid var(--border);">
        <input id="chat-input" class="input" placeholder="Type a message…" style="flex:1;border:1px solid var(--border);border-radius:12px;padding:10px 12px;">
        <button class="btn" id="chat-send">Send</button>
      </div>
      <div class="xsmall" style="padding:10px 12px;border-top:1px solid var(--border);">By continuing, you agree to stay anonymous until both sides opt-in. If an agent accepts, they agree to a 25% referral fee via our standard agreement.</div>
    </div>
  </div>

  <!-- Client Consent / PLID Modal -->
  <div id="client-consent-modal" class="modal hidden" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" style="width:min(520px,100%);">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);">
        <div class="h3">Before we introduce you</div>
        <button class="btn btn-outline" id="client-consent-close">Close</button>
      </div>
      <div style="padding:14px;">
        <p class="small">We keep your details private. We only reveal contact when <em>both</em> you and the agent opt-in.</p>
        <div style="display:grid;gap:10px;margin-top:10px;">
          <div><div class="xsmall">Email</div><input id="cc-email" class="input" placeholder="you@email.com"
               style="width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;"></div>
          <div><div class="xsmall">Mobile</div><input id="cc-phone" class="input" placeholder="+1 312-555-0199"
               style="width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;"></div>
          <label class="small" style="display:flex;gap:8px;align-items:center;">
            <input type="checkbox" id="cc-consent"> I agree to be registered as a protected lead so Agent Ranks can facilitate the introduction and referral terms.
          </label>
          <button class="btn" id="cc-continue">Continue</button>
          <div class="xsmall" id="cc-error" style="color:#b91c1c;display:none;">Please fill email, mobile, and consent.</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== Simple store & KPI ===== */
const AR_NS='agent_ranks';
function getStore(){try{return JSON.parse(localStorage.getItem(AR_NS)||'{}')}catch(e){return{}}}
function setStore(o){localStorage.setItem(AR_NS,JSON.stringify(o))}
const KPI=getStore().kpi||[]; function logEvent(type,data){KPI.push({ts:new Date().toISOString(),type,data});const s=getStore();s.kpi=KPI;setStore(s)}
function downloadKPI(){const blob=new Blob([JSON.stringify(KPI,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=Object.assign(document.createElement('a'),{href:url,download:'agent_ranks_kpi.json'});a.click();URL.revokeObjectURL(url)}

/* ===== DEMO / SAFE MODE CONFIG ===== */
const CONFIG = { DEMO_MODE:true, OUTBOUND_DISABLED:true };

/* ===== Brand badge ===== */
function createRankBadge(value,{size=32}={}) {
  const v=Math.max(0,Math.min(100,Math.round(value))), gid='g'+Math.random().toString(36).slice(2,7);
  const navy='#0B1F3B', gold='#C49A6C', track='#E2E8F0', text='#0F172A';
  const stroke=Math.max(4,Math.round(size*0.18)), c=size/2, r=(size/2)-(stroke/2)-1;
  const C=2*Math.PI*r, target=C*(1-v/100), fsz=Math.round(size*0.36);
  return `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${size} ${size}" width="${size}" height="${size}">
  <defs><linearGradient id="${gid}" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="${navy}"/><stop offset="100%" stop-color="${gold}"/></linearGradient></defs>
  <circle cx="${c}" cy="${c}" r="${r}" fill="#fff" stroke="${track}" stroke-width="${stroke}"/>
  <circle cx="${c}" cy="${c}" r="${r}" fill="none" stroke="url(#${gid})" stroke-width="${stroke}" stroke-linecap="round"
          stroke-dasharray="${C.toFixed(2)}" stroke-dashoffset="${target.toFixed(2)}"/>
  <text x="${c}" y="${c+Math.round(size*0.06)}" text-anchor="middle" font-family="system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial"
        font-weight="800" font-size="${fsz}" fill="${text}">${v}</text>
</svg>`}
document.getElementById('brand-badge').innerHTML=createRankBadge(98,{size:32})

/* ===== Hero rotation ===== */
const slides=[
  {el:document.getElementById('slide0'), title:'Accepted over ask', sub:'Bucktown • SFH • 11 days — “We met three great options anonymously and chose the one who sold our place in 11 days.”',
   src:'https://images.unsplash.com/photo-1560518883-ce09059eeffa?q=80&w=1600&auto=format&fit=crop'},
  {el:document.getElementById('slide1'), title:'Keys at the closing table', sub:'Lincoln Park • Condo — “The match understood we were first-time buyers at $800k. Perfect fit.”',
   src:'https://images.unsplash.com/photo-1560518883-90a2e0b8d29d?q=80&w=1600&auto=format&fit=crop'},
  {el:document.getElementById('slide2'), title:'SOLD — stress-free', sub:'North Shore — “Zero awkward calls. Just private chat until both sides said yes.”',
   src:'https://images.unsplash.com/photo-1560184897-a50f6f7d518f?q=80&w=1600&auto=format&fit=crop'}
];
const capTitle=document.getElementById('capTitle'), capSub=document.getElementById('capSub');
let heroIdx=0;
slides.forEach(s=>s.el.style.backgroundImage=`linear-gradient(180deg, rgba(0,0,0,0) 35%, rgba(0,0,0,.55) 100%), url('${s.src}')`);
setInterval(()=>{ slides[heroIdx].el.classList.remove('active'); heroIdx=(heroIdx+1)%slides.length; slides[heroIdx].el.classList.add('active'); capTitle.textContent=slides[heroIdx].title; capSub.textContent=slides[heroIdx].sub; },3800)

/* ===== PLID ===== */
async function sha256(str){ if(window.crypto?.subtle){const enc=new TextEncoder().encode(str);const buf=await crypto.subtle.digest('SHA-256',enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('')} let h=0;for(let i=0;i<str.length;i++){h=((h<<5)-h)+str.charCodeAt(i);h|=0}return 'fb-'+Math.abs(h) }
async function createPLID(email,phone){ const ts=new Date().toISOString(); const hash=await sha256((email||'')+'|'+(phone||'')+'|'+ts); const s=getStore(); s.plid={id:hash,email,phone,ts}; setStore(s); logEvent('plid_created',s.plid); return s.plid }
function getPLID(){return(getStore().plid)||null}
function openClientConsent(){document.getElementById('client-consent-modal').classList.remove('hidden')}
function closeClientConsent(){document.getElementById('client-consent-modal').classList.add('hidden')}
document.getElementById('client-consent-close').onclick=closeClientConsent
document.getElementById('cc-continue').onclick=async()=>{const email=document.getElementById('cc-email').value.trim();const phone=document.getElementById('cc-phone').value.trim();const ok=document.getElementById('cc-consent').checked;const err=document.getElementById('cc-error');if(!email||!phone||!ok){err.style.display='block';return}err.style.display='none';await createPLID(email,phone);closeClientConsent();if(window.__afterClientConsent){const fn=window.__afterClientConsent;window.__afterClientConsent=null;fn()}}

/* ===== Invite simulator (Shadow→Eligible) ===== */
const INVITE_DB={}; function inviteAgent(agentId,ttlMinutes=240){ if(CONFIG.OUTBOUND_DISABLED){ INVITE_DB[agentId]={expiresAt:Date.now()+ttlMinutes*60*1000,accepted:false}; return; } const until=Date.now()+ttlMinutes*60*1000; INVITE_DB[agentId]={expiresAt:until,accepted:false}; setTimeout(()=>{ if(INVITE_DB[agentId]) INVITE_DB[agentId].accepted=true },10000)}
function inviteStatus(agentId){const e=INVITE_DB[agentId]; if(!e) return {active:false}; return {active:true,accepted:!!e.accepted,remainingMs:Math.max(0,e.expiresAt-Date.now())}}

/* ===== Agents ===== */
let AGENTS=[
  {id:'A1',alias:'North Side Neighborhood Pro',neighborhoods:['Lincoln Park','Lakeview','Bucktown','Wicker Park'],propertyTypes:['Condo','Single Family','Townhome'],priceMin:500000,priceMax:1500000,focus:'Seller',marketing:5,negotiation:4,transactions12m:42,resources:['Staging','Pro Video','Paid Social'],brokerageMarketing:5,domVsArea:-7,spLpVsArea:1.2,buyDiscountVsArea:0.1,eligible:true},
  {id:'A2',alias:'Downtown High-Rise Specialist',neighborhoods:['West Loop','River North','Loop'],propertyTypes:['Condo','Loft'],priceMin:600000,priceMax:2000000,focus:'Seller',marketing:5,negotiation:3,transactions12m:55,resources:['3D Tours','In-Building Network','Broker Events'],brokerageMarketing:5,domVsArea:-9,spLpVsArea:0.8,buyDiscountVsArea:0.0,eligible:false},
  {id:'A3',alias:'First-Time Buyer Guide',neighborhoods:['Lincoln Square','Ravenswood','Avondale','Logan Square'],propertyTypes:['Condo','Townhome'],priceMin:300000,priceMax:800000,focus:'Buyer',marketing:3,negotiation:5,transactions12m:38,resources:['Lender Intros','Buyer Workshops','Offer Playbooks'],brokerageMarketing:4,domVsArea:0,spLpVsArea:0.0,buyDiscountVsArea:1.0,eligible:true},
  {id:'A4',alias:'Luxury Lakefront Team',neighborhoods:['Gold Coast','Streeterville','Old Town'],propertyTypes:['Condo','Single Family'],priceMin:1200000,priceMax:6000000,focus:'Seller',marketing:5,negotiation:4,transactions12m:29,resources:['International Network','Print Features','Private Showings'],brokerageMarketing:5,domVsArea:-6,spLpVsArea:1.6,buyDiscountVsArea:0.0,eligible:false}
];

/* ===== Scoring ===== */
const METRICS={neighborhood:{label:'Neighborhood specialization',weight:{Buyer:.22,Seller:.18}},productType:{label:'Product type fit',weight:{Buyer:.12,Seller:.12}},priceBand:{label:'Price band fit',weight:{Buyer:.12,Seller:.12}},roleFocus:{label:'Buyer/Seller focus',weight:{Buyer:.10,Seller:.10}},resources:{label:'Resources to achieve goals',weight:{Buyer:.18,Seller:.22}},brokerage:{label:'Brokerage marketing power',weight:{Buyer:.08,Seller:.12}},trackRecord:{label:'Success & track record',weight:{Buyer:.18,Seller:.14}}};
const agentMetrics={}; function recordAgentResponse(agentId,ms){agentMetrics[agentId]=agentMetrics[agentId]||{firstResponseMs:[]}; agentMetrics[agentId].firstResponseMs.push(ms)}
function responsivenessPenalty(agentId){const arr=(agentMetrics[agentId]?.firstResponseMs||[]); if(!arr.length) return 0; const sorted=[...arr].sort((a,b)=>a-b); const med=sorted[Math.floor(sorted.length/2)]; return med>14400000?4:0}
const clamp=(x,a=0,b=1)=>Math.max(a,Math.min(b,x));
function overlapRatio(range,aMin,aMax){const[pMin,pMax]=range||[0,0]; const inter=Math.max(0,Math.min(pMax,aMax)-Math.max(pMin,aMin)); const uni=Math.max(pMax,aMax)-Math.min(pMin,aMin); return uni>0?inter/uni:0}
function scoreAgent(agent,answers){
  const role=answers.role||'Buyer';
  const neighborhood=answers.location?(agent.neighborhoods.some(n=>n.toLowerCase().includes(answers.location.toLowerCase()))?1:0):.5;
  const productType=answers.propertyType?(agent.propertyTypes.includes(answers.propertyType)?1:0):.5;
  const priceBand=overlapRatio(answers.priceRange,agent.priceMin,agent.priceMax)||.5;
  const roleFocus=answers.role?(answers.role===agent.focus?1:0):.5;
  const m=agent.marketing/5, n=agent.negotiation/5;
  const wantsM=(answers.priorities||[]).includes('Marketing Power'), wantsN=(answers.priorities||[]).includes('Negotiation Strength');
  const resources=role==='Seller'?clamp(.7*m+.3*n+(wantsM?.1:0)):clamp(.7*n+.3*m+(wantsN?.1:0));
  const brokerage=agent.brokerageMarketing/5;
  const activity=Math.min(agent.transactions12m,50)/50;
  const domScore=role==='Seller'?clamp(.5+(-agent.domVsArea)/30):.5;
  const spLpScore=role==='Seller'?clamp((agent.spLpVsArea+3)/6):.5;
  const buyerDiscount=role==='Buyer'?clamp((agent.buyDiscountVsArea+2)/4):.5;
  const performance=role==='Seller'?clamp(.6*spLpScore+.4*domScore):buyerDiscount;
  const trackRecord=clamp(.6*performance+.4*activity);
  const raw={neighborhood,productType,priceBand,roleFocus,resources,brokerage,trackRecord};
  const parts=Object.entries(METRICS).map(([k,d])=>{const w=d.weight[role], s=raw[k]??0; return {id:k,label:d.label,weight:w,score:s,points:Math.round(s*w*100)}});
  const totalBase=parts.reduce((s,p)=>s+p.points,0), penalty=responsivenessPenalty(agent.id||agent.alias)||0, total=Math.max(0,totalBase-penalty);
  return { total, parts, raw, penalty }
}
function narrative(agent,answers){
  const bullets=[]; if(answers.location){const locs=agent.neighborhoods.filter(n=>n.toLowerCase().includes(answers.location.toLowerCase())).slice(0,2).join(', '); if(locs) bullets.push('Specializes near '+locs+'.')}
  if(answers.propertyType) bullets.push('Primary focus: '+answers.propertyType+'.');
  if(answers.priceRange) bullets.push('Comfortable in your price window ($'+Number(answers.priceRange[0]).toLocaleString()+'–$'+Number(answers.priceRange[1]).toLocaleString()+').');
  if(answers.role) bullets.push((answers.role==='Buyer'?'Buyer':'Seller')+'-oriented strategies.');
  if((answers.priorities||[]).includes('Marketing Power')) bullets.push('Strong marketing: '+(agent.resources||[]).slice(0,2).join(', ')+'.');
  if((answers.priorities||[]).includes('Negotiation Strength')) bullets.push('Known for sharp negotiations.');
  bullets.push(agent.transactions12m+' closings in last 12 months.'); return bullets
}

/* ===== Questionnaire wiring ===== */
const state={role:'',location:'',propertyType:'',priceRange:[400000,1000000],priorities:[],timing:'0-3 months'};
const stepEls=[...Array(6)].map((_,i)=>document.getElementById('step-'+i));
const nextBtn=document.getElementById('btn-next'), backBtn=document.getElementById('btn-back'), finishBtn=document.getElementById('btn-finish');
const progressBar=document.getElementById('progress-bar'), stepNum=document.getElementById('step-num');
const PROPERTY_TYPES=['Condo','Single Family','Townhome','Loft','Multi-Unit'];
const PRIORITIES=['Local Expertise','Marketing Power','Negotiation Strength','New Construction Access','Off-Market Access'];
let step=0;

(function renderPropertyTypes(){const h=document.getElementById('property-types'); h.innerHTML=''; PROPERTY_TYPES.forEach(pt=>{const b=document.createElement('button'); b.className='choice'; b.textContent=pt; b.onclick=()=>{state.propertyType=pt; h.querySelectorAll('.choice').forEach(x=>x.classList.remove('selected')); b.classList.add('selected')}; h.appendChild(b)})})();
(function renderPriorities(){const h=document.getElementById('priorities'); h.innerHTML=''; PRIORITIES.forEach(p=>{const b=document.createElement('button'); b.className='choice'; b.textContent=p; b.onclick=()=>{const i=state.priorities.indexOf(p); if(i>=0){state.priorities.splice(i,1); b.classList.remove('selected')} else {state.priorities.push(p); b.classList.add('selected')}}; h.appendChild(b)})})();
document.querySelectorAll('[data-role]').forEach(b=>{b.onclick=()=>{state.role=b.getAttribute('data-role'); document.querySelectorAll('[data-role]').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); goStep(1)}})
document.getElementById('input-location').oninput=(e)=>{state.location=e.target.value||''}
document.getElementById('price-min').oninput=(e)=>{state.priceRange[0]=+e.target.value||0}
document.getElementById('price-max').oninput=(e)=>{state.priceRange[1]=+e.target.value||0}
document.querySelectorAll('.timing').forEach(b=>{b.onclick=()=>{state.timing=b.getAttribute('data-val'); document.querySelectorAll('.timing').forEach(x=>x.classList.remove('selected')); b.classList.add('selected')}})
function goStep(n){step=n; stepEls.forEach((el,i)=>el.classList.toggle('hidden',i!==step)); stepNum.textContent=(step+1); progressBar.style.width=((step+1)/6*100)+'%'; backBtn.disabled=(step===0); nextBtn.classList.toggle('hidden',step===5); finishBtn.classList.toggle('hidden',step!==5)}
backBtn.onclick=()=>{if(step>0)goStep(step-1)}
nextBtn.onclick=()=>{if(step<5)goStep(step+1)}
finishBtn.onclick=()=>{document.getElementById('results').classList.remove('hidden'); renderResults(); location.hash='#results'; logEvent('quiz_complete', state)}
goStep(0)

/* ===== Results render ===== */
function renderResults(){
  const sc=AGENTS.map(a=>({agent:a,score:scoreAgent(a,state),bullets:narrative(a,state)})).sort((x,y)=>y.score.total-x.score.total);
  const top3=sc.slice(0,3), rest=sc.slice(3,10);
  const topEl=document.getElementById('top3'); topEl.innerHTML=''; top3.forEach(r=>topEl.appendChild(renderAgentCard(r)));
  const restEl=document.getElementById('rest'); restEl.innerHTML=''; rest.forEach(r=>restEl.appendChild(renderAgentSmall(r)));
}
function renderAgentCard(r){
  const wrap=document.createElement('div'); wrap.className='card'; wrap.style.padding='14px';
  const head=document.createElement('div'); head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center';
  head.innerHTML=`
    <div style="display:flex;align-items:center;gap:10px;">
      ${createRankBadge(r.score.total,{size:42})}
      <div><div class="xsmall">Top Match</div><div class="h3">${r.agent.alias}</div></div>
    </div>
    <div style="text-align:right;"><div style="font-size:24px;font-weight:800;">${r.score.total}</div><div class="xsmall">Fit score</div></div>`;
  wrap.appendChild(head);

  const ul=document.createElement('ul'); ul.className='list small'; ul.style.marginTop='8px';
  r.bullets.forEach(b=>{const li=document.createElement('li'); li.textContent=b; ul.appendChild(li)}); wrap.appendChild(ul);

  const pillbar=document.createElement('div'); pillbar.className='pillbar'; pillbar.style.marginTop='8px';
  r.agent.propertyTypes.forEach(t=>{const s=document.createElement('span'); s.className='chip'; s.textContent=t; pillbar.appendChild(s)});
  const f=document.createElement('span'); f.className='chip'; f.textContent=r.agent.focus+' focus'; pillbar.appendChild(f);
  wrap.appendChild(pillbar);

  const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='10px'; actions.style.marginTop='10px';
  const btnConnect=document.createElement('button'); btnConnect.className='btn'; btnConnect.textContent='Connect';
  const btnSave=document.createElement('button'); btnSave.className='btn btn-outline'; btnSave.textContent='Save for later';
  actions.appendChild(btnConnect); actions.appendChild(btnSave); wrap.appendChild(actions);

  const note=document.createElement('div'); note.className='xsmall'; note.style.marginTop='6px'; wrap.appendChild(note);
  function renderEligibility(){
    if(r.agent.eligible){ note.textContent='This agent is eligible for immediate introduction.'; }
    else { const st=inviteStatus(r.agent.id); if(!st.active){ inviteAgent(r.agent.id) } const ns=inviteStatus(r.agent.id);
      if(ns.accepted){ r.agent.eligible=true; note.textContent='Accepted — agent is now eligible.'; }
      else { const mins=Math.ceil((ns.remainingMs||0)/60000); note.textContent=`Top candidate pending acceptance (up to ${Math.max(mins,1)} min). We’ll introduce immediately upon acceptance.`; }
    }
  } renderEligibility();

  btnConnect.onclick=async()=>{ const plid=getPLID(); if(!plid){ window.__afterClientConsent=()=>doConnect(); openClientConsent(); } else { doConnect() } }
  async function doConnect(){
    if (CONFIG.DEMO_MODE) { logEvent('connect_revealed', {agentId:r.agent.id, score:r.score.total, demo:true}); openChat(r.agent); return; }
    if (r.agent.eligible || inviteStatus(r.agent.id).accepted){
      r.agent.eligible = true; logEvent('connect_revealed', {agentId:r.agent.id}); openChat(r.agent);
    } else {
      alert('We’ve invited this top candidate to accept the referral (up to 4 hours). In demo mode, outreach is disabled.');
      logEvent('connect_pending', {agentId:r.agent.id});
    }
  }
  return wrap
}
function renderAgentSmall(r){
  const wrap=document.createElement('div'); wrap.className='card'; wrap.style.padding='12px';
  const head=document.createElement('div'); head.style.display='flex'; head.style.justifyContent='space-between';
  head.innerHTML=`<div class="small" style="font-weight:700;display:flex;align-items:center;gap:8px;">${createRankBadge(r.score.total,{size:34})}${r.agent.alias}</div><div class="small" style="font-weight:700;">${r.score.total}</div>`;
  wrap.appendChild(head);
  const ul=document.createElement('ul'); ul.className='list xsmall'; ul.style.marginTop='6px';
  r.bullets.slice(0,3).forEach(b=>{const li=document.createElement('li'); li.textContent=b; ul.appendChild(li)}); wrap.appendChild(ul);
  const btn=document.createElement('button'); btn.className='btn'; btn.style.width='100%'; btn.style.marginTop='8px'; btn.textContent='Connect';
  btn.onclick=()=>alert('Use the top matches to connect immediately.'); wrap.appendChild(btn);
  return wrap
}

/* ===== Chat ===== */
const modal=document.getElementById('chat-modal'); const chatClose=document.getElementById('chat-close'); const chatMin=document.getElementById('chat-min'); const chatFab=document.getElementById('chat-fab');
function openChat(agent){
  document.getElementById('chat-title').textContent=agent.alias;
  const msgs=document.getElementById('chat-messages'); msgs.innerHTML='';
  appendMsg('system',"Anonymous chat created. Share only what you're comfortable with.");
  let firstClientMsgAt=0, agentReplied=false;
  const sendBtn=document.getElementById('chat-send'); const input=document.getElementById('chat-input');
  sendBtn.onclick=()=>{ const t=(input.value||'').trim(); if(!t) return; appendMsg('You',t); if(!firstClientMsgAt) firstClientMsgAt=Date.now(); input.value='';
    if(!agentReplied){ const delay=30000+Math.random()*150000; setTimeout(()=>{ appendMsg(agent.alias,'Thanks for reaching out — happy to help.'); agentReplied=true; recordAgentResponse(agent.id||agent.alias, Date.now()-firstClientMsgAt) },delay)} };
  showModal();
}
function appendMsg(who,text){const box=document.createElement('div');box.className='card';box.style.padding='8px 10px';box.style.maxWidth='80%';box.style.margin='6px 0';if(who==='You'){box.style.marginLeft='auto';box.style.background='#111827';box.style.color='#fff'};const w=document.createElement('div');w.className='xsmall';w.textContent=who;const t=document.createElement('div');t.className='small';t.style.marginTop='4px';t.textContent=text;box.appendChild(w);box.appendChild(t);const msgs=document.getElementById('chat-messages');msgs.appendChild(box);msgs.scrollTop=msgs.scrollHeight}
function showModal(){modal.classList.remove('hidden');modal.setAttribute('aria-hidden','false');document.getElementById('chat-input').focus()}
function hideModal(){modal.classList.add('hidden');modal.setAttribute('aria-hidden','true')}
document.getElementById('chat-send').onclick=()=>{} // replaced in openChat
chatClose.onclick=hideModal; chatMin.onclick=hideModal; modal.addEventListener('click',e=>{if(e.target===modal)hideModal()}); document.addEventListener('keydown',e=>{if(e.key==='Escape')hideModal()})
chatFab.onclick=()=>{ if(modal.classList.contains('hidden')){ document.getElementById('chat-title').textContent='Agent'; const msgs=document.getElementById('chat-messages'); msgs.innerHTML=''; appendMsg('system',"Anonymous chat created. Share only what you're comfortable with."); showModal() } else { hideModal() } }

/* ===== CSV Pilot ===== */
document.getElementById('load-sample').onclick=()=>{const sample=`id,alias,neighborhoods,propertyTypes,priceMin,priceMax,focus,marketing,negotiation,transactions12m,resources,brokerageMarketing,domVsArea,spLpVsArea,buyDiscountVsArea
X1,West Loop Condo Pro,West Loop;River North,Condo;Loft,600000,1600000,Seller,5,3,48,3D Tours;Broker Events;Pro Video,5,-8,1.1,0
X2,North Shore Seller Strategist,Winnetka;Glencoe;Evanston;Wilmette,Single Family,900000,3500000,Seller,5,4,34,Staging;Aerial Video;Broker Network,5,-8,1.3,0
X3,First-Time Buyer Guide,Lincoln Square;Ravenswood;Logan Square,Condo;Townhome,300000,800000,Buyer,3,5,38,Lender Intros;Buyer Workshops;Offer Playbooks,4,0,0,1.0`; document.getElementById('csv').value=sample; document.getElementById('status').textContent='Loaded sample. You can modify before importing.'}
document.getElementById('import').onclick=()=>{try{const txt=document.getElementById('csv').value||'';const lines=txt.trim().split(/\r?\n/);if(lines.length<2){document.getElementById('status').textContent='No rows detected. Check your CSV.';return}const headers=lines[0].split(',').map(h=>h.trim());const rows=[];for(let i=1;i<lines.length;i++){if(!lines[i].trim())continue;const cols=lines[i].split(',').map(c=>c.trim());const obj={};headers.forEach((h,idx)=>obj[h]=cols[idx]??'');const toList=v=>v?v.split(/;|\|/).map(x=>x.trim()).filter(Boolean):[];rows.push({id:obj.id||'R'+i,alias:obj.alias||('Agent '+i),neighborhoods:toList(obj.neighborhoods),propertyTypes:toList(obj.propertyTypes),priceMin:parseFloat(obj.priceMin||0),priceMax:parseFloat(obj.priceMax||0),focus:(obj.focus||'Seller').trim(),marketing:parseInt(obj.marketing||3),negotiation:parseInt(obj.negotiation||3),transactions12m:parseInt(obj.transactions12m||0),resources:toList(obj.resources),brokerageMarketing:parseInt(obj.brokerageMarketing||3),domVsArea:parseFloat(obj.domVsArea||0),spLpVsArea:parseFloat(obj.spLpVsArea||0),buyDiscountVsArea:parseFloat(obj.buyDiscountVsArea||0),eligible:true})} AGENTS=rows; document.getElementById('status').textContent='Imported '+rows.length+' agents. Matches now use your data.'; document.getElementById('results').classList.remove('hidden'); renderResults(); location.hash='#results'; logEvent('csv_import',{count:rows.length}) }catch(e){document.getElementById('status').textContent='Import error. Please check formatting.'}}

/* ===== DEMO RUNNER ===== */
function demoLog(msg){const el=document.getElementById('demo-log'); if(!el) return; const line=`[${new Date().toLocaleTimeString()}] ${msg}`; el.textContent=(line+'\n'+el.textContent).slice(0,20000)}
let DEMO_SCENARIOS=[];
function loadDemoScenarios(){
  DEMO_SCENARIOS = [
    {role:'Buyer',location:'Lincoln Park',propertyType:'Condo',priceRange:[600000,900000],priorities:['Negotiation Strength','Local Expertise'],timing:'0-3 months'},
    {role:'Seller',location:'West Loop',propertyType:'Loft',priceRange:[700000,1400000],priorities:['Marketing Power'],timing:'0-3 months'},
    {role:'Buyer',location:'Ravenswood',propertyType:'Townhome',priceRange:[450000,800000],priorities:['Local Expertise'],timing:'3-6 months'},
    {role:'Seller',location:'Gold Coast',propertyType:'Condo',priceRange:[1200000,3000000],priorities:['Marketing Power','Local Expertise'],timing:'0-3 months'},
    {role:'Buyer',location:'Hinsdale',propertyType:'Single Family',priceRange:[900000,1500000],priorities:['Negotiation Strength'],timing:'0-3 months'},
    {role:'Seller',location:'Lakeview',propertyType:'Condo',priceRange:[500000,1100000],priorities:['Marketing Power'],timing:'3-6 months'},
    {role:'Buyer',location:'Edgewater',propertyType:'Condo',priceRange:[250000,500000],priorities:['Local Expertise'],timing:'0-3 months'},
    {role:'Seller',location:'Winnetka',propertyType:'Single Family',priceRange:[1500000,3500000],priorities:['Marketing Power'],timing:'0-3 months'},
    {role:'Buyer',location:'South Loop',propertyType:'Loft',priceRange:[350000,800000],priorities:['Negotiation Strength'],timing:'0-3 months'},
    {role:'Seller',location:'Bucktown',propertyType:'Townhome',priceRange:[800000,1400000],priorities:['Marketing Power'],timing:'3-6 months'},
    {role:'Buyer',location:'Logan Square',propertyType:'Multi-Unit',priceRange:[500000,1200000],priorities:['Negotiation Strength'],timing:'0-3 months'},
    {role:'Seller',location:'Streeterville',propertyType:'Condo',priceRange:[900000,2000000],priorities:['Marketing Power'],timing:'0-3 months'},
    {role:'Buyer',location:'Old Town',propertyType:'Condo',priceRange:[600000,950000],priorities:['Local Expertise'],timing:'0-3 months'},
    {role:'Seller',location:'Western Springs',propertyType:'Single Family',priceRange:[800000,1600000],priorities:['Marketing Power'],timing:'0-3 months'},
    {role:'Buyer',location:'Evanston',propertyType:'Condo',priceRange:[350000,650000],priorities:['Negotiation Strength'],timing:'3-6 months'},
    {role:'Seller',location:'Wilmette',propertyType:'Single Family',priceRange:[1200000,2200000],priorities:['Marketing Power'],timing:'0-3 months'},
    {role:'Buyer',location:'River North',propertyType:'Condo',priceRange:[700000,1200000],priorities:['Negotiation Strength','Local Expertise'],timing:'0-3 months'},
    {role:'Seller',location:'Lincoln Square',propertyType:'Townhome',priceRange:[600000,1000000],priorities:['Marketing Power'],timing:'0-3 months'},
    {role:'Buyer',location:'Rogers Park',propertyType:'Condo',priceRange:[200000,450000],priorities:['Local Expertise'],timing:'0-3 months'},
    {role:'Seller',location:'Glencoe',propertyType:'Single Family',priceRange:[1400000,2600000],priorities:['Marketing Power'],timing:'0-3 months'}
  ];
  demoLog(`Loaded ${DEMO_SCENARIOS.length} demo scenarios.`);
  logEvent('demo_scenarios_loaded', {count: DEMO_SCENARIOS.length});
}
function pickTopEligibleAgent(scn){
  const ranked = AGENTS.map(a => ({agent:a, score:scoreAgent(a, scn)})).sort((x,y)=>y.score.total - x.score.total);
  return ranked.find(r => r.agent.eligible) || ranked[0];
}
function runOneDemo(idx){
  const scn = DEMO_SCENARIOS[idx % DEMO_SCENARIOS.length];
  state.role=scn.role; state.location=scn.location; state.propertyType=scn.propertyType;
  state.priceRange=scn.priceRange.slice(); state.priorities=scn.priorities.slice(); state.timing=scn.timing;
  renderResults(); logEvent('quiz_complete', scn);
  const pl = getPLID(); if(!pl){ createPLID(`demo${idx}@client.com`, `+1 312-555-0${String(idx).padStart(3,'0')}`) }
  const choice = pickTopEligibleAgent(scn);
  logEvent('connect_revealed', {agentId: choice.agent.id, demo:true});
  demoLog(`${idx+1}. ${scn.role} in ${scn.location} (${scn.propertyType} ${scn.priceRange[0]/1000}–${scn.priceRange[1]/1000}k) → ${choice.agent.alias} [score ${choice.score.total}]`);
  recordAgentResponse(choice.agent.id, 5*60*1000 + Math.random()*20*60*1000); // 5–25 min
  logEvent('deal_intake_saved', {side:scn.role,type:scn.propertyType,address:`${100+idx} Demo St, Chicago`});
  logEvent('deal_milestone', {ms:'offer'}); logEvent('deal_milestone', {ms:'pending'}); logEvent('deal_milestone', {ms:'ctc'}); logEvent('deal_milestone', {ms:'closed'});
  logEvent('referral_fee_paid', {amount: 4500 + Math.round(Math.random()*3500), paid_via:'settlement', demo:true});
}
function runDemoSessions(n=10){ if(!DEMO_SCENARIOS.length) loadDemoScenarios(); for(let i=0;i<n;i++) runOneDemo(i); demoLog(`Ran ${n} demo sessions. Use "Download KPI" to export.`); logEvent('demo_run', {count:n})}
document.getElementById('demo-load')?.addEventListener('click', loadDemoScenarios);
document.getElementById('demo-run')?.addEventListener('click', ()=>runDemoSessions(10));
document.getElementById('demo-download')?.addEventListener('click', downloadKPI);

/* ===== DASHBOARD ===== */
function $(id){ return document.getElementById(id); }
function asDate(tsStr){ try{ return new Date(tsStr) }catch(e){ return null } }
function daysAgo(n){ const d=new Date(); d.setDate(d.getDate()-n); d.setHours(0,0,0,0); return d; }
function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function getKPI(){ return (getStore().kpi || []).map(e => ({...e, ts: asDate(e.ts)})).filter(e => e.ts); }
function drawBars(ctx, labels, values, color){
  const w = ctx.canvas.width, h = ctx.canvas.height, pad = 20;
  const maxV = Math.max(1, ...values);
  const bw = (w - pad*2) / Math.max(1, values.length);
  ctx.clearRect(0,0,w,h); ctx.font='12px system-ui';
  values.forEach((v,i)=>{
    const x=pad+i*bw, bh=(h-pad*2)*(v/maxV);
    ctx.fillStyle=color; ctx.fillRect(x+6, h-pad-bh, bw-12, bh);
    ctx.fillStyle='#334155'; ctx.fillText(String(v), x+6, h-pad-bh-4);
    ctx.fillText(labels[i], x+6, h-6);
  });
  ctx.strokeStyle='#E2E8F0'; ctx.beginPath(); ctx.moveTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();
}
function drawLine(ctx, points, color){
  if (!points.length){ ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height); return; }
  const w=ctx.canvas.width, h=ctx.canvas.height, pad=20;
  const xs=points.map(p=>p.x), ys=points.map(p=>p.y);
  const minX=Math.min(...xs), maxX=Math.max(...xs), maxY=Math.max(1,...ys);
  const sx=x=> pad+((x-minX)/(maxX-minX||1))*(w-pad*2);
  const sy=y=> (h-pad) - (y/maxY)*(h-pad*2);
  ctx.clearRect(0,0,w,h);
  ctx.strokeStyle='#E2E8F0'; ctx.beginPath(); ctx.moveTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();
  ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
  points.forEach((p,i)=>{ const X=sx(p.x), Y=sy(p.y); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); });
  ctx.stroke(); ctx.fillStyle=color;
  points.forEach(p=>{ ctx.beginPath(); ctx.arc(sx(p.x), sy(p.y), 3, 0, Math.PI*2); ctx.fill(); });
}
function computeFunnel(kpi, windowDays=30){
  const since=daysAgo(windowDays); const inwin=kpi.filter(e=> e.ts>=since);
  const count=(name, pred=()=>true)=> inwin.filter(e=>e.type===name && pred(e)).length;
  const plid=count('plid_created'); const connect=count('connect_revealed'); const intake=count('deal_intake_saved');
  const closed=inwin.filter(e=>e.type==='deal_milestone' && e.data?.ms==='closed').length;
  const paid=count('referral_fee_paid'); return {plid,connect,intake,closed,paid};
}
function computeRevenue(kpi, windowDays=30){
  const since=daysAgo(windowDays); let sum=0,cnt=0;
  kpi.forEach(e=>{ if(e.ts>=since && e.type==='referral_fee_paid'){ const amt=Number(e.data?.amount||0); if(!isNaN(amt)){ sum+=amt; cnt++; } } });
  return { sum, cnt };
}
function computeSLA(){
  if (!window.agentMetrics) return { median:null, pct:null };
  const arr=Object.values(agentMetrics).flatMap(a=>a.firstResponseMs||[]);
  if(!arr.length) return { median:null, pct:null };
  const sorted=[...arr].sort((a,b)=>a-b), med=sorted[Math.floor(sorted.length/2)];
  const pct=arr.filter(ms=> ms<=4*60*60*1000).length/arr.length;
  return { median:med, pct };
}
function plidsPerDay(kpi, days=14){
  const counts={}; for(let d=0; d<days; d++){ const k=startOfDay(daysAgo(d)).toISOString().slice(0,10); counts[k]=0; }
  kpi.forEach(e=>{ if(e.type==='plid_created'){ const key=startOfDay(e.ts).toISOString().slice(0,10); if(counts[key]!==undefined) counts[key]+=1; } });
  const keys=Object.keys(counts).sort(); return keys.map((k,i)=>({x:i,y:counts[k],label:k}));
}
function supplySnapshot(){
  const eligible=AGENTS.filter(a=>a.eligible).length, shadow=AGENTS.length-eligible;
  const byType={}; AGENTS.forEach(a=> (a.propertyTypes||[]).forEach(t=> byType[t]=(byType[t]||0)+(a.eligible?1:0)));
  const types=Object.entries(byType).sort((a,b)=>b[1]-a[1]).map(([t,n])=>`${t}: ${n} eligible`).join(' • ');
  return { eligible, shadow, types };
}
function duration(ms){ if(!ms||ms<0) return '—'; const h=Math.floor(ms/3600000), m=Math.round((ms%3600000)/60000); return h?`${h}h ${m}m`:`${m}m`; }
function renderDashboard(){
  const kpi=(getStore().kpi||[]).map(e=>({...e,ts:new Date(e.ts||e.ts)})).filter(e=>!isNaN(e.ts));
  const funnel=computeFunnel(kpi,30), rev=computeRevenue(kpi,30), sla=computeSLA(), plids7=computeFunnel(kpi,7).plid;
  document.getElementById('tilePRC').textContent=funnel.paid; document.getElementById('tilePRCtxt').textContent=rev.sum?`$${rev.sum.toLocaleString()} paid last 30d`:'No paid fees yet';
  document.getElementById('tileSLA').textContent=sla.median!=null?duration(sla.median):'N/A'; document.getElementById('tileSLAtxt').textContent=sla.pct!=null?`Within 4h: ${(sla.pct*100).toFixed(0)}%`:'Run a demo chat to see SLA';
  document.getElementById('tilePLID').textContent=plids7; document.getElementById('tilePLIDtxt').textContent='Created last 7 days';
  drawBars(document.getElementById('chartFunnel').getContext('2d'), ['PLID','Connect','Intake','Closed','Paid'], [funnel.plid,funnel.connect,funnel.intake,funnel.closed,funnel.paid], '#0B1F3B');
  const pts=plidsPerDay(kpi,14); drawLine(document.getElementById('chartPLID').getContext('2d'), pts, '#C49A6C');
  const sup=supplySnapshot(); document.getElementById('supplyTxt').textContent=`Eligible agents: ${sup.eligible} · Shadow: ${sup.shadow} · By type: ${sup.types||'—'}`;
}
document.getElementById('demo-run')?.addEventListener('click', ()=> setTimeout(renderDashboard,50));

/* ===== Init ===== */
document.getElementById('year').textContent=new Date().getFullYear();
renderDashboard();
</script>
</body>
</html>

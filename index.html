import React, { useEffect, useMemo, useState } from "react";

/**
 * Agent Ranks — Best-fit Agent (Private Demo) with CSV Import
 * Single-file React app (Tailwind classes; no external deps).
 *
 * Features:
 * - Mobile-safe navbar (hamburger)
 * - Hero (rotating images + on-image captions)
 * - Questionnaire (6 steps) → Results (anonymized) → Anonymous chat
 * - Admin → Data (CSV import): file upload or paste; Load sample; live replace agents
 *
 * Notes:
 * - No outbound emails/texts/backends. All data lives in memory.
 * - CSV parser is pragmatic (comma-separated rows, semicolon-separated lists).
 *   Keep values simple (no quoted embedded commas). Good enough for pilot/testing.
 */

/* ----------------------------- Small helpers ----------------------------- */
const cx = (...xs) => xs.filter(Boolean).join(" ");
const clamp = (x, a = 0, b = 1) => Math.max(a, Math.min(b, x));
const overlapRatio = ([pMin, pMax], aMin, aMax) => {
  const inter = Math.max(0, Math.min(pMax, aMax) - Math.max(pMin, aMin));
  const uni = Math.max(pMax, aMax) - Math.min(pMin, aMin);
  return uni > 0 ? inter / uni : 0;
};

/* ----------------------------- Testimonials & hero ----------------------------- */
const TESTIMONIALS = [
  { quote: "We met three great options anonymously and chose the one who sold our place in 11 days.", who: "Seller in West Loop" },
  { quote: "The match understood we were first-time buyers in Lincoln Park at $800k. Perfect fit.", who: "Buyer in Lincoln Park" },
  { quote: "Zero awkward phone calls. Just a private chat until both sides said yes.", who: "Seller in Bucktown" },
];

// Replace these with your licensed images later
const HERO_SLIDES = [
  {
    badge: "SOLD",
    title: "Accepted over ask",
    caption: "Bucktown • SFH • 11 days",
    image: "https://images.unsplash.com/photo-1560518883-ce09059eeffa?q=80&w=1600&auto=format&fit=crop",
  },
  {
    badge: "UNDER CONTRACT",
    title: "Keys at the closing table",
    caption: "Lincoln Park • Condo • $800k",
    image: "https://images.unsplash.com/photo-1560518883-90a2e0b8d29d?q=80&w=1600&auto=format&fit=crop",
  },
  {
    badge: "PRIVATE",
    title: "Off-market preview",
    caption: "North Shore • Private showing",
    image: "https://images.unsplash.com/photo-1560184897-a50f6f7d518f?q=80&w=1600&auto=format&fit=crop",
  },
];

/* ----------------------------- Default agent seed ----------------------------- */
const SEED_AGENTS = [
  {
    id: "A1",
    alias: "North Side Neighborhood Pro",
    neighborhoods: ["Lincoln Park", "Lakeview", "Bucktown", "Wicker Park"],
    propertyTypes: ["Condo", "Single Family", "Townhome"],
    priceMin: 500000, priceMax: 1500000, focus: "Seller",
    marketing: 5, negotiation: 4, transactions12m: 42,
    resources: ["Staging", "Pro Video", "Paid Social"],
    brokerageMarketing: 5, domVsArea: -7, spLpVsArea: 1.2, buyDiscountVsArea: 0.1,
  },
  {
    id: "A2",
    alias: "Downtown High-Rise Specialist",
    neighborhoods: ["West Loop", "River North", "Loop"],
    propertyTypes: ["Condo", "Loft"],
    priceMin: 600000, priceMax: 2000000, focus: "Seller",
    marketing: 5, negotiation: 3, transactions12m: 55,
    resources: ["3D Tours", "In-Building Network", "Broker Events"],
    brokerageMarketing: 5, domVsArea: -9, spLpVsArea: 0.8, buyDiscountVsArea: 0.0,
  },
  {
    id: "A3",
    alias: "First-Time Buyer Guide",
    neighborhoods: ["Lincoln Square", "Ravenswood", "Avondale", "Logan Square"],
    propertyTypes: ["Condo", "Townhome"],
    priceMin: 300000, priceMax: 800000, focus: "Buyer",
    marketing: 3, negotiation: 5, transactions12m: 38,
    resources: ["Lender Intros", "Buyer Workshops", "Offer Playbooks"],
    brokerageMarketing: 4, domVsArea: 0, spLpVsArea: 0.0, buyDiscountVsArea: 1.0,
  },
  {
    id: "A4",
    alias: "Luxury Lakefront Team",
    neighborhoods: ["Gold Coast", "Streeterville", "Old Town"],
    propertyTypes: ["Condo", "Single Family"],
    priceMin: 1200000, priceMax: 6000000, focus: "Seller",
    marketing: 5, negotiation: 4, transactions12m: 29,
    resources: ["International Network", "Print Features", "Private Showings"],
    brokerageMarketing: 5, domVsArea: -6, spLpVsArea: 1.6, buyDiscountVsArea: 0.0,
  },
  {
    id: "A6",
    alias: "South Loop Buyers",
    neighborhoods: ["South Loop", "Printers Row"],
    propertyTypes: ["Condo", "Loft"],
    priceMin: 350000, priceMax: 1000000, focus: "Buyer",
    marketing: 3, negotiation: 5, transactions12m: 26,
    resources: ["New Build Access", "HOA Intel", "Inspection Playbook"],
    brokerageMarketing: 4, domVsArea: 0, spLpVsArea: 0.0, buyDiscountVsArea: 0.7,
  },
  {
    id: "A7",
    alias: "North Shore Seller Strategist",
    neighborhoods: ["Winnetka", "Glencoe", "Evanston", "Wilmette"],
    propertyTypes: ["Single Family"],
    priceMin: 900000, priceMax: 3500000, focus: "Seller",
    marketing: 5, negotiation: 4, transactions12m: 34,
    resources: ["Staging", "Aerial Video", "Broker Network"],
    brokerageMarketing: 5, domVsArea: -8, spLpVsArea: 1.3, buyDiscountVsArea: 0.0,
  },
];

/* ----------------------------- Scoring model ----------------------------- */
const METRICS = {
  neighborhood: { label: "Neighborhood specialization", weight: { Buyer: 0.22, Seller: 0.18 } },
  productType:  { label: "Product type fit",          weight: { Buyer: 0.12, Seller: 0.12 } },
  priceBand:    { label: "Price band fit",            weight: { Buyer: 0.12, Seller: 0.12 } },
  roleFocus:    { label: "Buyer/Seller focus",        weight: { Buyer: 0.10, Seller: 0.10 } },
  resources:    { label: "Resources to achieve goals",weight: { Buyer: 0.18, Seller: 0.22 } },
  brokerage:    { label: "Brokerage marketing power", weight: { Buyer: 0.08, Seller: 0.12 } },
  trackRecord:  { label: "Success & track record",    weight: { Buyer: 0.18, Seller: 0.14 } },
};

function scoreAgent(agent, answers) {
  const role = answers.role || "Buyer";

  const neighborhood = answers.location
    ? (agent.neighborhoods || []).some(n => n.toLowerCase().includes(answers.location.toLowerCase())) ? 1 : 0
    : 0.5;

  const productType = answers.propertyType
    ? (agent.propertyTypes || []).includes(answers.propertyType) ? 1 : 0
    : 0.5;

  const priceBand = answers.priceRange
    ? overlapRatio(answers.priceRange, agent.priceMin || 0, agent.priceMax || 0)
    : 0.5;

  const roleFocus = answers.role ? (answers.role === agent.focus ? 1 : 0) : 0.5;

  const m = (agent.marketing || 0) / 5;
  const n = (agent.negotiation || 0) / 5;
  const wantsM = (answers.priorities || []).includes("Marketing Power");
  const wantsN = (answers.priorities || []).includes("Negotiation Strength");
  const resources = role === "Seller"
    ? clamp(0.7 * m + 0.3 * n + (wantsM ? 0.1 : 0))
    : clamp(0.7 * n + 0.3 * m + (wantsN ? 0.1 : 0));

  const brokerage = (agent.brokerageMarketing || 0) / 5;

  const activity = Math.min(agent.transactions12m || 0, 50) / 50;
  const domScore = role === "Seller" ? clamp(0.5 + (-(agent.domVsArea || 0)) / 30) : 0.5;
  const spLpScore = role === "Seller" ? clamp(((agent.spLpVsArea || 0) + 3) / 6) : 0.5;
  const buyerDiscount = role === "Buyer" ? clamp(((agent.buyDiscountVsArea || 0) + 2) / 4) : 0.5;
  const performance = role === "Seller" ? clamp(0.6 * spLpScore + 0.4 * domScore) : buyerDiscount;
  const trackRecord = clamp(0.6 * performance + 0.4 * activity);

  const raw = { neighborhood, productType, priceBand, roleFocus, resources, brokerage, trackRecord };
  const parts = Object.entries(METRICS).map(([key, def]) => {
    const weight = def.weight[role];
    const score = raw[key] ?? 0;
    return { id: key, label: def.label, weight, score, points: Math.round(score * weight * 100) };
  });
  const total = parts.reduce((s, p) => s + p.points, 0);
  return { total, parts, raw };
}

function narrative(agent, answers) {
  const bullets = [];
  if (answers.location) {
    const locs = (agent.neighborhoods || [])
      .filter(n => n.toLowerCase().includes(answers.location.toLowerCase()))
      .slice(0, 2).join(", ");
    if (locs) bullets.push(`Specializes near ${locs}.`);
  }
  if (answers.propertyType) bullets.push(`Primary focus: ${answers.propertyType}.`);
  if (answers.priceRange) bullets.push(
    `Comfortable in your price window ($${answers.priceRange[0].toLocaleString()}–$${answers.priceRange[1].toLocaleString()}).`
  );
  if (answers.role) bullets.push(`${agent.focus}-oriented strategies.`);
  if ((answers.priorities || []).includes("Marketing Power"))
    bullets.push(`Strong marketing: ${(agent.resources || []).slice(0, 2).join(", ")}.`);
  if ((answers.priorities || []).includes("Negotiation Strength"))
    bullets.push(`Known for sharp negotiations.`);
  bullets.push(`${agent.transactions12m || 0} closings in last 12 months.`);
  return bullets;
}

/* ----------------------------- Layout primitives ----------------------------- */
function Section({ id, title, subtitle, children }) {
  return (
    <section id={id} className="relative mx-auto max-w-6xl px-4 py-16 sm:py-20">
      {title && (
        <div className="mb-8">
          <h2 className="text-2xl sm:text-3xl font-semibold tracking-tight text-gray-900">{title}</h2>
          {subtitle && <p className="mt-2 max-w-3xl text-gray-600">{subtitle}</p>}
        </div>
      )}
      {children}
    </section>
  );
}

function Pill({ children }) {
  return (
    <span className="inline-flex items-center rounded-full border border-white/20 bg-white/10 px-3 py-1 text-xs font-medium text-white backdrop-blur-sm">
      {children}
    </span>
  );
}

/* ----------------------------- Navbar ----------------------------- */
function Navbar() {
  const [open, setOpen] = useState(false);
  return (
    <header className="sticky top-0 z-40 w-full border-b border-gray-200/80 bg-white/70 backdrop-blur supports-[backdrop-filter]:bg-white/60">
      <div className="mx-auto flex max-w-6xl items-center justify-between px-4 py-3">
        <div className="flex items-center gap-2">
          <div className="h-8 w-8 rounded-xl bg-gradient-to-br from-indigo-500 via-fuchsia-500 to-rose-500" />
          <span className="text-sm font-semibold tracking-tight text-gray-900">Agent Ranks</span>
        </div>

        {/* Desktop nav */}
        <nav className="hidden gap-6 text-sm text-gray-700 sm:flex">
          <a href="#how" className="hover:text-gray-900">How it works</a>
          <a href="#questionnaire" className="hover:text-gray-900">Get matched</a>
          <a href="#results" className="hover:text-gray-900">Results</a>
          <a href="#admin" className="hover:text-gray-900">Data (CSV)</a>
        </nav>

        {/* CTA + mobile button */}
        <div className="flex items-center gap-2">
          <a href="#questionnaire" className="hidden rounded-xl bg-gray-900 px-3 py-2 text-xs font-semibold text-white shadow hover:bg-gray-800 sm:inline-flex">
            Find my best match
          </a>
          <button onClick={() => setOpen(!open)} className="inline-flex items-center rounded-lg border border-gray-200 px-3 py-2 text-xs font-semibold sm:hidden" aria-label="Open menu">
            Menu
          </button>
        </div>
      </div>

      {/* Mobile menu */}
      {open && (
        <div className="border-t border-gray-200 sm:hidden">
          <div className="mx-auto grid max-w-6xl gap-2 px-4 py-3 text-sm">
            <a onClick={() => setOpen(false)} href="#how">How it works</a>
            <a onClick={() => setOpen(false)} href="#questionnaire">Get matched</a>
            <a onClick={() => setOpen(false)} href="#results">Results</a>
            <a onClick={() => setOpen(false)} href="#admin">Data (CSV)</a>
          </div>
        </div>
      )}
    </header>
  );
}

/* ----------------------------- Hero ----------------------------- */
function Hero() {
  const [tIdx, setTIdx] = useState(0);
  const [sIdx, setSIdx] = useState(0);

  useEffect(() => {
    const t1 = setInterval(() => setTIdx(i => (i + 1) % TESTIMONIALS.length), 4000);
    const t2 = setInterval(() => setSIdx(i => (i + 1) % HERO_SLIDES.length), 3500);
    return () => { clearInterval(t1); clearInterval(t2); };
  }, []);

  const t = TESTIMONIALS[tIdx];
  const s = HERO_SLIDES[sIdx];

  return (
    <div className="relative isolate overflow-hidden">
      <div className="absolute inset-0 -z-10 opacity-20 [background-image:radial-gradient(1000px_800px_at_0%_0%,white,transparent)]" />
      <div className="mx-auto max-w-6xl px-4 py-20 sm:py-28">
        <div className="grid items-center gap-10 sm:grid-cols-2">
          {/* Left copy */}
          <div>
            <Pill>Unbiased • Credit Score Level Ratings</Pill>
            <h1 className="mt-4 text-3xl font-semibold tracking-tight text-gray-900 sm:text-5xl">
              Agent Ranks — find your best-fit real estate agent, privately
            </h1>
            <p className="mt-4 max-w-xl text-gray-700">
              50+ matching signals (neighborhood, product type, price band, buyer/seller focus, marketing power, track record).
              We present your best 3 matches — with no names or contact until <em>both</em> sides opt-in.
            </p>
            <div className="mt-6 flex items-center gap-3">
              <a href="#questionnaire" className="rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-gray-800">
                Start 2-minute match
              </a>
              <a href="#how" className="text-sm font-medium text-gray-800 hover:text-gray-900">How it works</a>
            </div>

            {/* rotating testimonial */}
            <div className="mt-6 max-w-xl rounded-2xl bg-gray-900/90 p-4 text-white ring-1 ring-black/10">
              <p className="text-sm">“{t.quote}”</p>
              <p className="mt-1 text-xs text-white/80">— {t.who}</p>
            </div>
          </div>

          {/* Right image with overlay labels */}
          <div className="relative">
            <div className="aspect-[4/3] w-full overflow-hidden rounded-3xl ring-1 ring-gray-200">
              <div
                className="relative flex h-full items-end justify-between p-6 text-white transition-all duration-700"
                style={{
                  backgroundImage: `linear-gradient(180deg, rgba(0,0,0,0.0) 35%, rgba(0,0,0,.55) 100%), url('${s.image}')`,
                  backgroundSize: "cover",
                  backgroundPosition: "center",
                }}
              >
                <div className="pointer-events-none select-none">
                  <div className="inline-flex rotate-[-8deg] rounded-xl border-2 border-white/70 bg-white/10 px-3 py-1 text-xs font-black tracking-widest shadow">
                    {s.badge}
                  </div>
                  <div className="mt-3 text-lg font-semibold drop-shadow">{s.title}</div>
                  <div className="text-xs opacity-90">{s.caption}</div>
                </div>
                <div className="flex flex-col items-end gap-2 text-right text-[11px]">
                  <div className="rounded-xl bg-white/15 px-3 py-2 ring-1 ring-white/30">Anonymous chat ready</div>
                  <div className="rounded-xl bg-white/15 px-3 py-2 ring-1 ring-white/30">No contact shared</div>
                  <div className="rounded-xl bg-white/15 px-3 py-2 ring-1 ring-white/30">Mutual opt-in</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  );
}

/* ----------------------------- How it works ----------------------------- */
function HowItWorks() {
  const steps = [
    { title: "Tell us your goals", text: "Buyer or seller, neighborhood, property type, price band, timing, and key priorities." },
    { title: "AI-assisted matching", text: "We weigh 50+ signals to rank agents most likely to achieve your outcome." },
    { title: "Anonymous introductions", text: "Review short narratives for your top matches without exposing identity or contact info." },
    { title: "Mutual opt-in & connect", text: "If you approve, we open a private chat. When both sides agree, we connect directly." },
  ];
  return (
    <Section id="how" title="How it works" subtitle="Unbiased, data-driven matches. Comfortable, private introductions.">
      <ol className="grid gap-6 sm:grid-cols-2 lg:grid-cols-4">
        {steps.map((s, i) => (
          <li key={i} className="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
            <div className="mb-2 inline-flex h-8 w-8 items-center justify-center rounded-full bg-gray-900 text-xs font-semibold text-white">{i + 1}</div>
            <h3 className="text-sm font-semibold text-gray-900">{s.title}</h3>
            <p className="mt-1 text-sm text-gray-600">{s.text}</p>
          </li>
        ))}
      </ol>
    </Section>
  );
}

/* ----------------------------- Questionnaire ----------------------------- */
function Questionnaire({ onComplete }) {
  const [role, setRole] = useState("");
  const [location, setLocation] = useState("");
  const [propertyType, setPropertyType] = useState("");
  const [priceRange, setPriceRange] = useState([400000, 1000000]);
  const [priorities, setPriorities] = useState([]);
  const [timing, setTiming] = useState("0-3 months");
  const [step, setStep] = useState(0);

  const PRIORITY_OPTIONS = ["Local Expertise", "Marketing Power", "Negotiation Strength", "New Construction Access", "Off-Market Access"];

  const togglePriority = (p) =>
    setPriorities((curr) => (curr.includes(p) ? curr.filter((x) => x !== p) : [...curr, p]));

  const next = () => setStep((s) => Math.min(s + 1, 5));
  const back = () => setStep((s) => Math.max(s - 1, 0));
  const finish = () => onComplete({ role, location, propertyType, priceRange, priorities, timing });

  const canNext = useMemo(() => {
    if (step === 0) return !!role;
    if (step === 1) return location.trim().length > 1;
    if (step === 2) return !!propertyType;
    if (step === 3) return priceRange && priceRange[0] < priceRange[1];
    if (step === 4) return priorities.length > 0;
    return true;
  }, [step, role, location, propertyType, priceRange, priorities]);

  return (
    <Section id="questionnaire" title="Get matched in under 2 minutes" subtitle="We only share anonymized needs until you choose to connect.">
      <div className="rounded-3xl border border-gray-200 bg-white p-5 shadow-sm">
        <div className="mb-4 flex items-center justify-between">
          <div className="text-xs text-gray-600">Step {step + 1} of 6</div>
          <div className="h-2 w-40 rounded bg-gray-100"><div className="h-full rounded bg-gray-900" style={{ width: `${((step + 1) / 6) * 100}%` }} /></div>
        </div>

        {step === 0 && (
          <div>
            <h4 className="text-sm font-semibold text-gray-900">Are you buying or selling?</h4>
            <div className="mt-3 grid gap-3 sm:grid-cols-2">
              {["Buyer", "Seller"].map((opt) => (
                <button key={opt} onClick={() => setRole(opt)} className={cx("rounded-xl border px-4 py-3 text-left text-sm",
                  role === opt ? "border-gray-900 bg-gray-900 text-white" : "border-gray-200 hover:border-gray-300")}>
                  <div className="font-medium">{opt}</div>
                  <div className="text-gray-500">{opt === "Buyer" ? "We’ll prioritize negotiation and availability." : "We’ll prioritize marketing power and days-on-market."}</div>
                </button>
              ))}
            </div>
          </div>
        )}

        {step === 1 && (
          <div>
            <h4 className="text-sm font-semibold text-gray-900">What neighborhood or area?</h4>
            <input value={location} onChange={(e) => setLocation(e.target.value)}
              placeholder="e.g., West Loop, Lincoln Park, Hinsdale"
              className="mt-3 w-full rounded-xl border border-gray-200 px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-gray-900" />
            <p className="mt-2 text-xs text-gray-500">Tip: You can be specific (e.g., “Bucktown”) or broader (e.g., “North Shore”).</p>
          </div>
        )}

        {step === 2 && (
          <div>
            <h4 className="text-sm font-semibold text-gray-900">Property type</h4>
            <div className="mt-3 grid gap-3 sm:grid-cols-3">
              {["Condo", "Single Family", "Townhome", "Loft", "Multi-Unit"].map((opt) => (
                <button key={opt} onClick={() => setPropertyType(opt)} className={cx("rounded-xl border px-4 py-3 text-left text-sm",
                  propertyType === opt ? "border-gray-900 bg-gray-900 text-white" : "border-gray-200 hover:border-gray-300")}>
                  {opt}
                </button>
              ))}
            </div>
          </div>
        )}

        {step === 3 && (
          <div>
            <h4 className="text-sm font-semibold text-gray-900">Price range</h4>
            <div className="mt-3 grid gap-3 sm:grid-cols-2">
              <div>
                <label className="text-xs text-gray-600">Min</label>
                <input type="number" value={priceRange[0]} onChange={(e) => setPriceRange([+e.target.value, priceRange[1]])}
                  className="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-gray-900" />
              </div>
              <div>
                <label className="text-xs text-gray-600">Max</label>
                <input type="number" value={priceRange[1]} onChange={(e) => setPriceRange([priceRange[0], +e.target.value])}
                  className="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-gray-900" />
              </div>
            </div>
            <p className="mt-2 text-xs text-gray-500">Change later if you’re uncertain.</p>
          </div>
        )}

        {step === 4 && (
          <div>
            <h4 className="text-sm font-semibold text-gray-900">What matters most?</h4>
            <div className="mt-3 grid gap-3 sm:grid-cols-2">
              {PRIORITY_OPTIONS.map((opt) => (
                <label key={opt} className={cx("flex cursor-pointer items-center gap-3 rounded-xl border px-4 py-3 text-sm",
                  priorities.includes(opt) ? "border-gray-900 bg-gray-900 text-white" : "border-gray-200 hover:border-gray-300")}>
                  <input type="checkbox" checked={priorities.includes(opt)} onChange={() => togglePriority(opt)} className="hidden" />
                  <span>{opt}</span>
                </label>
              ))}
            </div>
          </div>
        )}

        {step === 5 && (
          <div>
            <h4 className="text-sm font-semibold text-gray-900">Timing</h4>
            <div className="mt-3 grid gap-3 sm:grid-cols-3">
              {["0-3 months", "3-6 months", "6-12 months"].map((opt) => (
                <button key={opt} onClick={() => setTiming(opt)} className={cx("rounded-xl border px-4 py-3 text-left text-sm",
                  timing === opt ? "border-gray-900 bg-gray-900 text-white" : "border-gray-200 hover:border-gray-300")}>
                  {opt}
                </button>
              ))}
            </div>
          </div>
        )}

        <div className="mt-6 flex items-center justify-between">
          <button onClick={back} disabled={step === 0} className={cx("rounded-xl px-4 py-2 text-sm",
            step === 0 ? "cursor-not-allowed bg-gray-100 text-gray-400" : "bg-gray-200 text-gray-800 hover:bg-gray-300")}>
            Back
          </button>
          {step < 5 ? (
            <button onClick={next} disabled={!canNext} className={cx("rounded-xl px-4 py-2 text-sm font-semibold",
              canNext ? "bg-gray-900 text-white hover:bg-gray-800" : "cursor-not-allowed bg-gray-900/30 text-white/60")}>
              Next
            </button>
          ) : (
            <button onClick={finish} className="rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800">
              See my matches
            </button>
          )}
        </div>

        <p className="mt-4 text-xs text-gray-500">Your details remain private. We only open a chat if you approve your matches and the agent agrees.</p>
      </div>
    </Section>
  );
}

/* ----------------------------- Results & cards ----------------------------- */
function AgentCard({ agent, score, bullets, onChat }) {
  const [showWhy, setShowWhy] = useState(false);
  const [showMetrics, setShowMetrics] = useState(false);
  return (
    <div className="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
      <div className="flex items-center justify-between">
        <div>
          <div className="text-xs font-semibold uppercase tracking-wide text-gray-500">Top Match</div>
          <h4 className="text-base font-semibold text-gray-900">{agent.alias}</h4>
        </div>
        <div className="text-right">
          <div className="text-2xl font-bold text-gray-900">{score.total}</div>
          <div className="text-[10px] uppercase text-gray-500">Fit score</div>
        </div>
      </div>

      <ul className="mt-3 list-disc space-y-1 pl-5 text-sm text-gray-700">
        {bullets.map((b, i) => <li key={i}>{b}</li>)}
      </ul>

      <div className="mt-3 flex items-center gap-4 text-xs">
        <button onClick={() => setShowWhy(v => !v)} className="font-semibold text-gray-700 underline underline-offset-2">
          {showWhy ? "Hide scoring" : "Why this match?"}
        </button>
        <button onClick={() => setShowMetrics(v => !v)} className="font-semibold text-gray-700 underline underline-offset-2">
          {showMetrics ? "Hide metrics" : "View metrics"}
        </button>
      </div>

      {showWhy && (
        <div className="mt-2 rounded-xl bg-gray-50 p-3">
          <ul className="space-y-1 text-xs text-gray-700">
            {score.parts.map((p) => (
              <li key={p.id} className="flex items-center justify-between">
                <span>{p.label}</span>
                <span className="tabular-nums">
                  {Math.round(p.score * 100)}% × {Math.round(p.weight * 100)}% = <strong>{p.points}</strong>
                </span>
              </li>
            ))}
          </ul>
        </div>
      )}

      {showMetrics && (
        <div className="mt-2 rounded-xl bg-gray-50 p-3 text-xs text-gray-700">
          <div className="grid grid-cols-2 gap-2 md:grid-cols-3">
            <Metric label="Transactions (12m)" value={agent.transactions12m} />
            <Metric label="DOM vs Area (seller)" value={`${agent.domVsArea} days`} />
            <Metric label="SP/LP Δ vs Area (seller)" value={`${agent.spLpVsArea}%`} />
            <Metric label="Buyer Price Δ vs Area" value={`${agent.buyDiscountVsArea}%`} />
            <Metric label="Marketing" value={`${agent.marketing}/5`} />
            <Metric label="Negotiation" value={`${agent.negotiation}/5`} />
            <Metric label="Brokerage Marketing" value={`${agent.brokerageMarketing}/5`} />
            <div className="col-span-2">
              <div className="text-gray-500">Neighborhoods</div>
              <div className="font-semibold">{(agent.neighborhoods || []).join(", ")}</div>
            </div>
          </div>
        </div>
      )}

      <div className="mt-4 flex flex-wrap items-center gap-2 text-xs text-gray-600">
        {(agent.propertyTypes || []).map((t) => <span key={t} className="rounded-full bg-gray-100 px-2 py-1">{t}</span>)}
        <span className="rounded-full bg-gray-100 px-2 py-1">{agent.focus} focus</span>
      </div>

      <div className="mt-5 flex items-center gap-3">
        <button onClick={() => onChat(agent)} className="rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800">
          Open anonymous chat
        </button>
        <button className="rounded-xl border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-800 hover:bg-gray-50">
          Save for later
        </button>
      </div>

      <p className="mt-3 text-[11px] text-gray-500">No names or contact details shown. If both sides opt-in, we’ll connect you directly.</p>
    </div>
  );
}

function Metric({ label, value }) {
  return (
    <div>
      <div className="text-gray-500">{label}</div>
      <div className="font-semibold">{value}</div>
    </div>
  );
}

function Results({ answers, onStartChat, agents }) {
  const ranked = useMemo(() => {
    return (agents || []).map((a) => {
      const s = scoreAgent(a, answers);
      return { agent: a, score: s, bullets: narrative(a, answers) };
    }).sort((x, y) => y.score.total - x.score.total);
  }, [answers, agents]);

  const top3 = ranked.slice(0, 3);
  const rest = ranked.slice(3, 10);

  return (
    <Section id="results" title="Your best-fit matches" subtitle="We highlight the top three based on your goals. You can still browse up to ten options.">
      <div className="grid gap-5 lg:grid-cols-3">
        {top3.map((r) => (
          <AgentCard key={r.agent.id} agent={r.agent} score={r.score} bullets={r.bullets} onChat={onStartChat} />
        ))}
      </div>

      <div className="mt-10">
        <h3 className="text-sm font-semibold text-gray-900">Other relevant options</h3>
        <div className="mt-3 grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {rest.map((r) => (
            <div key={r.agent.id} className="rounded-2xl border border-gray-200 bg-white p-4">
              <div className="flex items-center justify-between">
                <div className="text-sm font-semibold text-gray-900">{r.agent.alias}</div>
                <div className="text-sm font-semibold text-gray-700">{r.score.total}</div>
              </div>
              <ul className="mt-2 list-disc space-y-1 pl-5 text-xs text-gray-600">
                {r.bullets.slice(0, 3).map((b, i) => <li key={i}>{b}</li>)}
              </ul>
              <button onClick={() => onStartChat(r.agent)} className="mt-3 w-full rounded-xl bg-gray-900 px-3 py-2 text-xs font-semibold text-white hover:bg-gray-800">
                Chat anonymously
              </button>
            </div>
          ))}
        </div>
      </div>
    </Section>
  );
}

/* ----------------------------- Chat modal ----------------------------- */
function ChatModal({ open, onClose, agent, answers }) {
  const [messages, setMessages] = useState([]);
  const [draft, setDraft] = useState("");

  useEffect(() => {
    if (!open) return;
    setMessages([
      { who: "system", text: "Anonymous chat created. Share only what you're comfortable with." },
      { who: agent?.alias || "Agent", text: `Hi there! Happy to help. I can advise on ${answers?.propertyType?.toLowerCase() || "your goals"} in ${answers?.location || "your area"}.` },
    ]);
  }, [open, agent, answers]);

  if (!open) return null;

  const send = () => {
    if (!draft.trim()) return;
    setMessages((m) => [...m, { who: "You", text: draft.trim() }]);
    setDraft("");
  };

  return (
    <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/50 p-4 sm:items-center">
      <div className="w-full max-w-2xl rounded-2xl bg-white shadow-xl">
        <div className="flex items-center justify-between border-b p-4">
          <div>
            <div className="text-xs uppercase text-gray-500">Anonymous chat</div>
            <div className="text-sm font-semibold text-gray-900">{agent?.alias}</div>
          </div>
          <button onClick={onClose} className="rounded-lg bg-gray-100 px-3 py-1 text-xs font-semibold text-gray-700 hover:bg-gray-200">Close</button>
        </div>

        <div className="h-64 overflow-y-auto p-4">
          <ul className="space-y-3">
            {messages.map((m, i) => (
              <li key={i} className={cx("max-w-[85%] rounded-xl px-3 py-2 text-sm",
                m.who === "You" ? "ml-auto bg-gray-900 text-white" : "bg-gray-100 text-gray-900")}>
                <div className="text-[10px] font-semibold text-gray-500">{m.who}</div>
                <div className="mt-1 text-[13px]">{m.text}</div>
              </li>
            ))}
          </ul>
        </div>

        <div className="flex items-center gap-2 border-t p-3">
          <input value={draft} onChange={(e) => setDraft(e.target.value)} placeholder="Type a message…"
            className="flex-1 rounded-xl border border-gray-200 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-gray-900" />
          <button onClick={send} className="rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800">Send</button>
        </div>

        <div className="border-t p-3 text-[11px] text-gray-500">Demo mode: no identities or contact details are shared. No emails or texts are sent.</div>
      </div>
    </div>
  );
}

/* ----------------------------- Admin: CSV import ----------------------------- */
function AdminCSV({ onReplaceAgents }) {
  const [csvText, setCsvText] = useState("");
  const [status, setStatus] = useState("");
  const [fileName, setFileName] = useState("");

  const sample = `id,alias,neighborhoods,propertyTypes,priceMin,priceMax,focus,marketing,negotiation,transactions12m,resources,brokerageMarketing,domVsArea,spLpVsArea,buyDiscountVsArea
X1,West Loop Condo Pro,West Loop;River North,Condo;Loft,600000,1600000,Seller,5,3,48,3D Tours;Broker Events;Pro Video,5,-8,1.1,0
X2,North Shore Seller Strategist,Winnetka;Glencoe;Evanston;Wilmette,Single Family,900000,3500000,Seller,5,4,34,Staging;Aerial Video;Broker Network,5,-8,1.3,0
X3,First-Time Buyer Guide,Lincoln Square;Ravenswood;Logan Square,Condo;Townhome,300000,800000,Buyer,3,5,38,Lender Intros;Buyer Workshops;Offer Playbooks,4,0,0,1.0`;

  const parseCSV = (text) => {
    const lines = text.trim().split(/\r?\n/).filter(Boolean);
    if (!lines.length) throw new Error("No rows detected.");
    const headers = lines[0].split(",").map((h) => h.trim());
    const toList = (v) => (v ? v.split(/;|\|/).map((x) => x.trim()).filter(Boolean) : []);
    const rows = [];

    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(",").map((c) => c.trim());
      const obj = {};
      headers.forEach((h, idx) => (obj[h] = cols[idx] ?? ""));

      rows.push({
        id: obj.id || `R${i}`,
        alias: obj.alias || `Agent ${i}`,
        neighborhoods: toList(obj.neighborhoods),
        propertyTypes: toList(obj.propertyTypes),
        priceMin: parseFloat(obj.priceMin || 0),
        priceMax: parseFloat(obj.priceMax || 0),
        focus: (obj.focus || "Seller").trim(),
        marketing: parseInt(obj.marketing || 3),
        negotiation: parseInt(obj.negotiation || 3),
        transactions12m: parseInt(obj.transactions12m || 0),
        resources: toList(obj.resources),
        brokerageMarketing: parseInt(obj.brokerageMarketing || 3),
        domVsArea: parseFloat(obj.domVsArea || 0),
        spLpVsArea: parseFloat(obj.spLpVsArea || 0),
        buyDiscountVsArea: parseFloat(obj.buyDiscountVsArea || 0),
      });
    }
    return rows;
  };

  const importCSV = () => {
    try {
      const rows = parseCSV(csvText);
      onReplaceAgents(rows);
      setStatus(`Imported ${rows.length} agents. Matches now use your data.`);
    } catch (e) {
      setStatus(`Import error: ${e.message}`);
    }
  };

  const onPickFile = async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    setFileName(f.name);
    const text = await f.text();
    setCsvText(text);
    setStatus(`Loaded file: ${f.name} (${text.length.toLocaleString()} bytes)`);
  };

  return (
    <Section id="admin" title="Data (CSV import)" subtitle="Paste a CSV or upload a .csv file to replace the agent dataset for testing.">
      <div className="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
        <div className="text-sm text-gray-700">
          <p><strong>Columns:</strong> <code>id, alias, neighborhoods (;), propertyTypes (;), priceMin, priceMax, focus, marketing, negotiation, transactions12m, resources (;), brokerageMarketing, domVsArea, spLpVsArea, buyDiscountVsArea</code></p>
          <p className="mt-2">Use <strong>semicolons</strong> for multi-values (e.g., <code>West Loop;River North</code>).</p>
        </div>

        <div className="mt-4 grid gap-4 md:grid-cols-2">
          <div>
            <label className="text-xs text-gray-600">Upload .csv</label>
            <input type="file" accept=".csv,text/csv" onChange={onPickFile}
              className="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 text-sm" />
            {fileName && <div className="mt-1 text-xs text-gray-500">Selected: {fileName}</div>}
          </div>
          <div>
            <label className="text-xs text-gray-600">Or paste CSV here</label>
            <textarea rows={8} value={csvText} onChange={(e) => setCsvText(e.target.value)}
              className="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 text-sm font-mono" placeholder={sample} />
          </div>
        </div>

        <div className="mt-3 flex flex-wrap items-center gap-3">
          <button onClick={() => { setCsvText(sample); setStatus("Sample loaded into the box."); }}
            className="rounded-xl border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-800 hover:bg-gray-50">
            Load sample
          </button>
          <button onClick={importCSV}
            className="rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800">
            Import CSV
          </button>
          <span className="text-xs text-gray-600">{status}</span>
        </div>
      </div>
    </Section>
  );
}

/* ----------------------------- App root ----------------------------- */
export default function App() {
  const [answers, setAnswers] = useState(null);
  const [chatOpen, setChatOpen] = useState(false);
  const [chatAgent, setChatAgent] = useState(null);
  const [agents, setAgents] = useState(SEED_AGENTS);

  const onComplete = (a) => {
    setAnswers(a);
    setTimeout(() => document.getElementById("results")?.scrollIntoView({ behavior: "smooth" }), 60);
  };
  const onStartChat = (agent) => { setChatAgent(agent); setChatOpen(true); };
  const onReplaceAgents = (rows) => {
    setAgents(rows);
    if (answers) {
      // re-run results scroll
      setTimeout(() => document.getElementById("results")?.scrollIntoView({ behavior: "smooth" }), 60);
    }
  };

  return (
    <div className="min-h-screen bg-white text-gray-900">
      <Navbar />
      <Hero />
      <HowItWorks />
      <Questionnaire onComplete={onComplete} />
      {answers && <Results answers={answers} onStartChat={onStartChat} agents={agents} />}
      <AdminCSV onReplaceAgents={onReplaceAgents} />
      <footer className="border-t border-gray-200/80 bg-white/60">
        <div className="mx-auto flex max-w-6xl flex-col items-center justify-between gap-4 px-4 py-8 sm:flex-row">
          <p className="text-xs text-gray-500">© {new Date().getFullYear()} Agent Ranks — Demo Concept (Private)</p>
          <div className="flex items-center gap-4 text-xs">
            <a href="#how" className="text-gray-600 hover:text-gray-900">How it works</a>
            <a href="#questionnaire" className="text-gray-600 hover:text-gray-900">Get matched</a>
            <a href="#results" className="text-gray-600 hover:text-gray-900">Results</a>
            <a href="#admin" className="text-gray-600 hover:text-gray-900">Data (CSV)</a>
          </div>
        </div>
      </footer>

      <ChatModal open={chatOpen} onClose={() => setChatOpen(false)} agent={chatAgent} answers={answers} />
    </div>
  );
}
